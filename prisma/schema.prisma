// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// User model
model User {
  id                  String   @id @default(cuid())
  email               String   @unique
  name                String?
  googleId            String?  @unique
  passwordHash        String?
  subscriptionTier    String   @default("free") // "free" | "creator" | "pro"
  subscriptionEndsAt  DateTime?
  dodoCustomerId      String?  @unique
  dodoSubscriptionId  String?  // For recurring subscription tracking
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  generations         VoiceGeneration[]
  usageStats          UsageStats?
}

// Voice generation record
model VoiceGeneration {
  id                String   @id @default(cuid())
  userId            String
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  scriptText        String   // Original script
  language          String   // "english" | "hindi" | "hinglish" | etc.
  voiceId           String   // Sarvam voice ID
  voiceName         String?  // Display name

  previewUrl        String?  // URL to 5-sec MP3
  audioUrl          String?  // URL to full MP3
  audioFileName     String?  // e.g. "my-script-123.mp3"

  status            String   @default("pending") // "pending" | "processing" | "completed" | "failed"
  errorMessage      String?

  durationSeconds   Int?     // Final audio duration
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([userId])
  @@index([createdAt])
}

// Usage tracking â€” generationsThisMonth only ever increases, never decremented on delete
model UsageStats {
  id                String   @id @default(cuid())
  userId            String   @unique
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  generationsThisMonth Int  @default(0)
  monthStartDate    DateTime @default(now())

  updatedAt         DateTime @updatedAt
}

// Payment tracking
model Payment {
  id                String   @id @default(cuid())
  userId            String
  dodoOrderId       String   @unique
  status            String   // "pending" | "completed" | "failed"
  amount            Float
  currency          String   @default("INR")
  plan              String   @default("pro") // "creator" | "pro"
  subscriptionMonths Int     @default(1)
  createdAt         DateTime @default(now())
  completedAt       DateTime?
}
